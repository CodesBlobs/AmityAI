var Qe=Object.defineProperty;var Ze=(e,r,t)=>r in e?Qe(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t;var ge=(e,r,t)=>Ze(e,typeof r!="symbol"?r+"":r,t);import{B as Ke,d as et,M as tt,S as Ye,G as ze,e as We,i as ie}from"./provider.factory.VK-m3o9h.js";import{M as f,L as Te,T as L}from"./tools.D9zwH9nK.js";import{buildSystemPrompt as rt,BROWSER_AGENT_PROMPT as Ve}from"./prompts.BA8uWoHA.js";import{S as st}from"./config.CXf-J2WI.js";const he=class he extends Ke{constructor(){super("TTSService");ge(this,"speaking",!1);ge(this,"queue",[]);ge(this,"currentUtteranceId",null);ge(this,"voices",[])}static getInstance(){return he.instance||(he.instance=new he),he.instance}async initialize(){await this.loadVoices(),this.logger.debug("TTS service initialized")}async loadVoices(){return new Promise(t=>{chrome.tts.getVoices(s=>{!s||s.length===0?(this.logger.warn("No TTS voices available - speech may not work. Please check your system TTS settings."),this.voices=[]):(this.voices=s.map(a=>({voiceName:a.voiceName??"unknown",lang:a.lang??"en-US",remote:a.remote??!1})),this.logger.debug(`Loaded ${this.voices.length} voices:`,this.voices.slice(0,5).map(a=>`${a.voiceName} (${a.lang})`).join(", "))),t()})})}getVoices(){return[...this.voices]}findVoice(t="en-US"){let s=this.voices.find(a=>a.lang===t);if(!s){const a=t.split("-")[0];s=this.voices.find(c=>c.lang.startsWith(a??""))}return s??this.voices[0]}async speak(t,s={}){if(await this.ensureInitialized(),this.voices.length===0)throw this.logger.error("Cannot speak: No TTS voices available"),new Error("No TTS voices available. Please check your system TTS settings.");this.queue.push({text:t,options:s}),this.speaking||await this.processQueue()}async processQueue(){if(this.speaking||this.queue.length===0)return;const t=this.queue.shift();if(t)return this.speaking=!0,new Promise((s,a)=>{const{text:c,options:i={}}=t,F=this.findVoice(i.lang);chrome.tts.speak(c,{rate:i.rate??1,pitch:i.pitch??1,volume:i.volume??1,voiceName:i.voiceName??(F==null?void 0:F.voiceName),lang:i.lang??(F==null?void 0:F.lang)??"en-US",onEvent:w=>{w.type==="end"||w.type==="cancelled"||w.type==="error"?(this.speaking=!1,this.currentUtteranceId=null,w.type==="error"?(this.logger.error("TTS error",w),a(new Error("TTS error"))):(this.logger.debug(`TTS ${w.type}: "${c.substring(0,50)}..."`),s()),this.processQueue().catch(console.error)):w.type==="start"&&this.logger.debug(`TTS started: "${c.substring(0,50)}..."`)}})})}stop(){chrome.tts.stop(),this.speaking=!1,this.queue=[],this.currentUtteranceId=null,this.logger.debug("TTS stopped")}pause(){chrome.tts.pause(),this.logger.debug("TTS paused")}resume(){chrome.tts.resume(),this.logger.debug("TTS resumed")}isSpeaking(){return this.speaking}getQueueLength(){return this.queue.length}clearQueue(){this.queue=[],this.logger.debug("TTS queue cleared")}async speakImportant(t){await this.speak(t,{rate:.9,pitch:1.1,volume:1})}async speakGuidance(t){await this.speak(t,{rate:.8,pitch:.95,volume:1})}async dispose(){this.stop(),await super.dispose()}};ge(he,"instance",null);let Be=he,Ie=null;function oe(){return Ie||(Ie={storage:Ye.getInstance(),messaging:tt.getInstance(),debugger:et.getInstance(),tts:Be.getInstance()}),Ie}async function nt(){const e=oe();await Promise.all([e.storage.ensureInitialized(),e.messaging.ensureInitialized(),e.debugger.ensureInitialized(),e.tts.ensureInitialized()])}const Me={identity:{firstName:"",lastName:"",email:"",phone:"",dateOfBirth:""},address:{street:"",city:"",state:"",postcode:"",country:""},payment:{cardNumber:"",cardName:"",expiry:"",cvv:""},shipping:{preferredMethod:"",defaultAddressSameAsBilling:!0}},je="proto-debug-key",ye=class ye extends Ke{constructor(){super("ProfileService")}static getInstance(){return ye.instance||(ye.instance=new ye),ye.instance}async initialize(){await this.getProfile()||await this.saveProfile(Me),this.logger.info("ProfileService initialized")}async getProfile(){try{const r=await chrome.storage.local.get("userProfile");return r.userProfile?this.decryptProfile(r.userProfile):Me}catch(r){return this.handleError(r,"getProfile"),Me}}async saveProfile(r){try{const t=this.encryptProfile(r);await chrome.storage.local.set({userProfile:t}),this.logger.debug("Profile saved")}catch(t){this.handleError(t,"saveProfile")}}encryptProfile(r){return{...r,payment:{...r.payment,cardNumber:this.xor(r.payment.cardNumber),cvv:this.xor(r.payment.cvv)}}}decryptProfile(r){return{...r,payment:{...r.payment,cardNumber:this.xor(r.payment.cardNumber),cvv:this.xor(r.payment.cvv)}}}xor(r){let t="";for(let s=0;s<r.length;s++)t+=String.fromCharCode(r.charCodeAt(s)^je.charCodeAt(s%je.length));return t}};ge(ye,"instance");let Le=ye;const J=new Te("MessageHandler");function it(){const{messaging:e,storage:r}=oe();e.registerHandler(f.GET_SETTINGS,async()=>({success:!0,data:await r.getSettings()})),e.registerHandler(f.SETTINGS_UPDATED,async t=>(await r.set("settings",t),J.debug("Settings updated",t),{success:!0})),e.registerHandler(f.GET_STATUS,async()=>({success:!0,data:{enabled:!0,stats:await r.getStats()}})),e.registerHandler(f.UPDATE_STATUS,async t=>(J.debug("Status update",t),{success:!0})),e.registerHandler(f.GET_CONTEXT,async()=>({success:!0,data:await r.getLastSession()??{startTime:Date.now(),completedSteps:[]}})),e.registerHandler(f.SET_CURRENT_TASK,async t=>(await r.updateSession({currentTask:t.task}),J.info("Task set",t.task),{success:!0})),e.registerHandler(f.COMPLETE_STEP,async t=>{const s=await r.getLastSession(),a=[...(s==null?void 0:s.completedSteps)??[],t.step];return await r.updateSession({completedSteps:a}),J.debug("Step completed",t.step),{success:!0}}),e.registerHandler(f.GUIDANCE_REQUESTED,async(t,s)=>{var a,c;J.info("Guidance requested for element:",(a=t.element)==null?void 0:a.selector);try{return(c=s.tab)!=null&&c.id&&(await chrome.sidePanel.open({tabId:s.tab.id}),await r.set("guidanceActivation",{type:"element",element:t.element,url:t.url,pageState:t.pageState,timestamp:Date.now()})),{success:!0}}catch(i){return J.error("Failed to open sidepanel for guidance:",i),{success:!1,error:i.message}}}),e.registerHandler(f.PAGE_EXPLANATION,async(t,s)=>{var a;J.info("Page explanation requested:",t.title);try{if(await r.set("guidanceActivation",{type:"page",url:t.url,title:t.title,pageType:t.pageType,pageState:t.pageState,timestamp:Date.now()}),(a=s.tab)!=null&&a.id){let c=!1;try{await chrome.sidePanel.open({tabId:s.tab.id}),c=!0,J.debug("Sidepanel opened successfully")}catch{J.debug("Could not auto-open sidepanel from keyboard event")}if(!c){await chrome.action.setBadgeText({text:"1",tabId:s.tab.id}),await chrome.action.setBadgeBackgroundColor({color:"#FF6B00",tabId:s.tab.id}),await e.sendToTab(s.tab.id,f.SHOW_GUIDANCE,{guidance:"üìñ Page explanation ready! Click the extension icon to view.",showArrow:!1});const i=s.tab.id;setTimeout(async()=>{try{await chrome.action.setBadgeText({text:"",tabId:i})}catch{}},3e4)}}return{success:!0}}catch(c){return J.error("Failed to handle page explanation:",c),{success:!1,error:c.message}}}),e.registerHandler(f.PAGE_QUESTION,async(t,s)=>{var a;J.info("Page question received:",t.question),console.log("[MessageHandler] PAGE_QUESTION received. Full payload:",t);try{if((a=s.tab)!=null&&a.id){let i=!1;try{await chrome.sidePanel.open({tabId:s.tab.id}),i=!0,J.debug("Sidepanel opened successfully for question")}catch{J.debug("Could not auto-open sidepanel from keyboard event")}if(!i){await chrome.action.setBadgeText({text:"?",tabId:s.tab.id}),await chrome.action.setBadgeBackgroundColor({color:"#FF6B00",tabId:s.tab.id}),await e.sendToTab(s.tab.id,f.SHOW_GUIDANCE,{guidance:"‚ùì Your question is ready! Click the extension icon to see the answer.",showArrow:!1});const F=s.tab.id;setTimeout(async()=>{try{await chrome.action.setBadgeText({text:"",tabId:F})}catch{}},3e4)}}const c={type:"question",url:t.url,title:t.title,pageType:t.pageType,pageState:t.pageState,question:t.question,timestamp:Date.now()};return console.log("[MessageHandler] Storing guidanceActivation:",c),await r.set("guidanceActivation",c),{success:!0}}catch(c){return J.error("Failed to handle page question:",c),{success:!1,error:c.message}}}),J.info("Message handlers registered")}const ke=new Te("BehaviorHandler"),le={lastAnalysisTime:0,analysisInterval:3e3,behaviorHistory:[]};function ot(){const{messaging:e,storage:r,debugger:t,tts:s}=oe();e.registerHandler(f.BEHAVIOR_REPORT,async(a,c)=>{var F;return((F=c.tab)==null?void 0:F.id)?(le.behaviorHistory.push(...a.behaviors),le.behaviorHistory.length>50&&(le.behaviorHistory=le.behaviorHistory.slice(-50)),ke.debug("Behavior report received",{events:a.behaviors.length,pageType:a.pageType}),{success:!0}):{success:!1,error:"No tab ID"}}),e.registerHandler(f.REQUEST_ANALYSIS,async(a,c)=>{var w,X,ue,de;const i=(w=c.tab)==null?void 0:w.id;if(!i)return{success:!1,error:"No tab ID"};const F=Date.now();if(!a.immediate&&F-le.lastAnalysisTime<le.analysisInterval)return{success:!1,error:"Rate limited"};le.lastAnalysisTime=F;try{const z=await r.getSettings(),be=await t.captureScreenshot(i),W=await e.sendToTab(i,f.GET_PAGE_STATE,{}),Re=z.useDemoKey?ze:z.apiKey,xe=We({provider:z.provider,apiKey:Re,model:z.model,baseUrl:z.baseUrl||void 0});let we=rt("general");z.strictBrowserAgentMode&&(we=`${Ve}

${we}`);let se=`Analyze this page and the user's recent behavior. If they seem confused, provide helpful guidance.

    When using the attached screenshot, do NOT output raw image/base64 data or paste verbatim OCR text. Instead provide a short, human-readable summary (1-2 sentences) of the relevant visual cues and guidance.

    Page URL: ${((X=c.tab)==null?void 0:X.url)??"Unknown"}
    Page Title: ${((ue=c.tab)==null?void 0:ue.title)??"Unknown"}

    Recent behaviors: ${JSON.stringify(le.behaviorHistory.slice(-5))}

`;const ae=(W==null?void 0:W.url)??((de=c.tab)==null?void 0:de.url)??"",Fe=(W==null?void 0:W.title)??"",Ee=z.preferredRetailer??"any",Ce=/amazon\.com\.au/i.test(ae)?"Amazon Australia":/amazon\./i.test(ae)?"Amazon":/ebay\.com\.au/i.test(ae)?"eBay Australia":/ebay\./i.test(ae)?"eBay":/walmart\./i.test(ae)?"Walmart":null;if(Ce&&(se+=`
**Current Retailer:** You are currently on **${Ce}**.
`),(W==null?void 0:W.pageType)==="shopping"){const Se=(W==null?void 0:W.productCards)??[];Se.length>0&&(se+=`
**Detected products (first 5):**
`,Se.slice(0,5).forEach((pe,Ne)=>{const Pe=pe.price??"MISSING",l=pe.rating??"MISSING",m=(pe.title||"").slice(0,120)||"Unknown title";se+=`- ${Ne+1}. ${m}; Price: ${Pe}; Rating: ${l}; Link: ${pe.link??"none"}
`}),Ee&&Ee!=="any"&&(se+=`
User preference: prioritize ${Ee} if available.
`),se+=`
If any product is missing a price or rating, state that explicitly. Prioritize Prime-eligible listings, lower delivery time, and seller reliability when recommending.`)}se+=`
[Screenshot attached]`;const ce=(await xe.chat({messages:[{role:"system",content:we},{role:"user",content:[{type:"text",text:se},{type:"image_url",image_url:{url:be}}]}]})).message.content;return ce&&(await e.sendToTab(i,f.SHOW_GUIDANCE,{guidance:ce,voiceText:z.voiceEnabled?ce:void 0}),await r.incrementStat("guidanceCount"),z.voiceEnabled&&z.autoReadGuidance&&(await s.speakGuidance(ce),await r.incrementStat("voiceAnnouncements"))),{success:!0,data:{guidance:ce}}}catch(z){return ke.error("Analysis failed",z),{success:!1,error:z instanceof Error?z.message:"Analysis failed"}}}),e.registerHandler(f.META_KEY_HELP,async(a,c)=>{var F;const i=(F=c.tab)==null?void 0:F.id;if(!i)return{success:!1,error:"No tab ID"};try{const w=await r.getSettings(),X=await t.captureScreenshot(i),ue=w.useDemoKey?ze:w.apiKey,de=We({provider:w.provider,apiKey:ue,model:w.model,baseUrl:w.baseUrl||void 0});let z="You are a helpful assistant. The user pressed the Meta key (Command/Windows key) for quick help. Provide brief, clear guidance about the element they are looking at.";w.strictBrowserAgentMode&&(z=`${Ve}

${z}`);const W=(await de.chat({messages:[{role:"system",content:z},{role:"user",content:[{type:"text",text:`The user pressed the Meta key (Command/Windows key) for help while hovering at coordinates (${a.x}, ${a.y}). The selector is: ${a.selector??"unknown"}. When using the attached screenshot, do NOT output raw image/base64 data or paste verbatim OCR text. Instead provide a short, human-readable summary (1-2 sentences) of the element and how the user should interact with it. What is this element and how should they interact with it?`},{type:"image_url",image_url:{url:X}}]}]})).message.content;return W&&(await e.sendToTab(i,f.SHOW_GUIDANCE,{selector:a.selector,guidance:W,showArrow:!0,voiceText:w.voiceEnabled?W:void 0}),w.voiceEnabled&&await s.speak(W)),{success:!0,data:{guidance:W}}}catch(w){return ke.error("Alt-key help failed",w),{success:!1,error:"Help request failed"}}}),e.registerHandler(f.SPEAK_TEXT,async a=>{try{return await s.speak(a.text,a.options),{success:!0}}catch{return{success:!1,error:"TTS failed"}}}),e.registerHandler(f.STOP_SPEAKING,async()=>(s.stop(),{success:!0})),ke.info("Behavior handlers registered")}const at=new Te("InspectionUtil");async function He(e,r){var t;if(!r)throw new Error("I cannot find this control on the current page.");try{const a=(t=(await chrome.scripting.executeScript({target:{tabId:e},world:"MAIN",func:c=>{const i=document.querySelector(c);if(!i)return{exists:!1};const F=i.getBoundingClientRect(),w=window.getComputedStyle(i);return{exists:!0,visible:F.width>0&&F.height>0&&w.visibility!=="hidden"&&w.display!=="none"&&w.opacity!=="0",text:(i.innerText||i.getAttribute("aria-label")||"").slice(0,200)}},args:[r]}))[0])==null?void 0:t.result;if(!a||!a.exists)throw new Error("I cannot find this control on the current page.");if(!a.visible)throw new Error("I need to scroll to load more content.");at.debug("Inspection result",{selector:r,previewText:a.text})}catch(s){throw s instanceof Error&&(s.message.includes("I cannot find")||s.message.includes("I need to scroll"))?s:new Error("I cannot find this control on the current page.")}}const ct=new Te("FieldMapper");class lt{mapFields(r,t){const s={},a=this.flattenProfile(t);for(const c of r){if(!c.isVisible)continue;const i=this.findMatch(c,a);i&&(s[c.field_id]=i,ct.debug("Mapped field",{field:c.name,label:c.label,semanticType:c.semanticType,value:"***"}))}return s}flattenProfile(r){const t={};return r.identity&&(r.identity.firstName&&(t.firstName=r.identity.firstName),r.identity.lastName&&(t.lastName=r.identity.lastName),r.identity.firstName&&r.identity.lastName&&(t.fullName=`${r.identity.firstName} ${r.identity.lastName}`),r.identity.email&&(t.email=r.identity.email),r.identity.phone&&(t.phone=r.identity.phone)),r.address&&(r.address.street&&(t.streetAddress=r.address.street),r.address.city&&(t.city=r.address.city),r.address.state&&(t.state=r.address.state),r.address.postcode&&(t.zipCode=r.address.postcode),r.address.country&&(t.country=r.address.country)),r.payment&&(r.payment.cardName&&(t.cardName=r.payment.cardName),r.payment.cardNumber&&(t.cardNumber=r.payment.cardNumber),r.payment.expiry&&(t.cardExpiry=r.payment.expiry),r.payment.cvv&&(t.cardCvc=r.payment.cvv)),t.firstName&&(t.first_name=t.firstName),t.lastName&&(t.last_name=t.lastName),t.streetAddress&&(t.street_address=t.streetAddress),t.zipCode&&(t.zip_code=t.zipCode),t.cardNumber&&(t.card_number=t.cardNumber),t.cardExpiry&&(t.card_expiry=t.cardExpiry),t.cardCvc&&(t.card_cvc=t.cardCvc),t}findMatch(r,t){if(r.semanticType&&r.semanticType!=="text"&&t[r.semanticType])return t[r.semanticType];const s=(r.label+" "+r.name+" "+r.placeholder+" "+r.autocomplete).toLowerCase(),a=r.inputType.toLowerCase();return a==="email"||s.includes("email")||s.includes("e-mail")?t.email||null:a==="tel"||s.includes("phone")||s.includes("mobile")||s.includes("cell")||s.includes("telefon")?t.phone||null:s.includes("first name")||s.includes("firstname")||s.includes("given name")||s.includes("forename")||s.includes("pr√©nom")?t.firstName||null:s.includes("last name")||s.includes("lastname")||s.includes("surname")||s.includes("family name")?t.lastName||null:s.includes("full name")||s.includes("your name")||s.match(/^name$/i)||s.includes("cardholder")||s.includes("name on card")?s.includes("card")&&t.cardName?t.cardName:t.fullName||null:s.includes("address line 1")||s.includes("street address")||s.includes("address 1")||s.includes("address")&&!s.includes("email")&&!s.includes("2")&&!s.includes("line 2")?t.streetAddress||null:s.includes("address line 2")||s.includes("address 2")||s.includes("apt")||s.includes("suite")||s.includes("unit")?t.addressLine2||null:s.includes("city")||s.includes("town")||s.includes("suburb")||s.includes("locality")?t.city||null:s.includes("state")||s.includes("province")||s.includes("region")||s.includes("county")?t.state||null:s.includes("zip")||s.includes("postal")||s.includes("postcode")||s.includes("post code")?t.zipCode||null:s.includes("country")||s.includes("nation")?t.country||null:s.includes("card number")||s.includes("credit card")||s.includes("cc num")||s.includes("card no")?t.cardNumber||null:s.includes("expir")||s.includes("exp date")||s.includes("mm/yy")||s.includes("mm / yy")||s.includes("valid")?t.cardExpiry||null:(s.includes("cvv")||s.includes("cvc")||s.includes("security code")||s.includes("csv")||s.includes("cid"))&&t.cardCvc||null}}const Ge="/chunks/amazon.ts.Crt3mSkK.js",Ue="/chunks/ebay-au.ts.CV_YT2J9.js",$e="/chunks/walmart.ts.KnyQC-L-.js",u=new Te("ToolHandler");function ut(){const{messaging:e,debugger:r,tts:t,storage:s}=oe();e.registerHandler(f.EXECUTE_TOOL,async(a,c)=>{var w;const i=((w=c.tab)==null?void 0:w.id)??await Oe();if(!i)return{success:!1,error:"No active tab"};const F=await s.getSettings();u.debug("Executing tool",{name:a.name,args:a.arguments,strictMode:F.strictBrowserAgentMode});try{return{success:!0,data:await dt(i,a)}}catch(X){return u.error("Tool execution failed",X),{success:!1,error:X instanceof Error?X.message:"Tool execution failed"}}}),e.registerHandler(f.FORCE_COMPLETE_TASK,async(a,c)=>{var F;const i=((F=c.tab)==null?void 0:F.id)??await Oe();if(!i)return{success:!1,error:"No active tab"};try{return{success:!0,data:await pt(i)}}catch(w){return u.error("Force complete task failed",w),{success:!1,error:w instanceof Error?w.message:"Force complete task failed"}}}),e.registerHandler(f.ATTACH_DEBUGGER,async a=>(await r.attach(a.tabId),{success:!0})),e.registerHandler(f.DETACH_DEBUGGER,async a=>(await r.detach(a.tabId),{success:!0})),e.registerHandler(f.DEBUGGER_STATUS,async a=>({success:!0,data:{attached:r.isAttached(a.tabId)}})),e.registerHandler(f.CDP_COMMAND,async(a,c)=>{var F;const i=a.tabId??((F=c.tab)==null?void 0:F.id)??await Oe();if(!i)return{success:!1,error:"No tab ID"};try{return{success:!0,data:await r.sendCommand(i,a.method,a.params)}}catch(w){return{success:!1,error:w instanceof Error?w.message:"CDP command failed"}}}),e.registerHandler(f.CAPTURE_SCREENSHOT,async(a,c)=>{var F;const i=((F=c.tab)==null?void 0:F.id)??await Oe();if(!i)return{success:!1,error:"No tab ID"};try{return{success:!0,data:{dataUrl:await r.captureScreenshot(i,{format:a.format,quality:a.quality,fullPage:a.fullPage})}}}catch{return{success:!1,error:"Screenshot failed"}}}),u.info("Tool handlers registered")}async function dt(e,r){var X,ue,de,z,be,W,Re,xe,we,se,ae,Fe,Ee,Ce,De,ce,Se,pe,Ne,Pe;const{debugger:t,tts:s,messaging:a}=oe(),{name:c,arguments:i}=r;console.log(`
`),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log("ü§ñ [LLM] FUNCTION CALL RECEIVED"),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log(`üìû Function name: ${c}`),console.log("üìã Arguments:"),console.log(JSON.stringify(i,null,2)),console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`);try{const l=await chrome.tabs.get(e),m=(l==null?void 0:l.url)??"";(m.startsWith("chrome://")||m.startsWith("chrome-extension://")||m.startsWith("about:"))&&(u.info("Detected restricted URL, auto-navigating to Google...",{currentUrl:m}),await t.navigate(e,"https://www.google.com"),await new Promise(S=>setTimeout(S,2e3)))}catch(l){u.warn("Failed to check/navigate from restricted URL",l)}console.log(`‚öôÔ∏è  [TOOL HANDLER] Executing: ${c}`);const{storage:F}=oe();let w;try{w=await F.getSettings()}catch(l){u.error("Failed to load settings in tool handler",l),w={provider:void 0,apiKey:"",model:"",baseUrl:"",confirmTools:!1,permissionLevel:1,searchUrl:"https://www.google.com/search?q=",voiceEnabled:!1,voiceRate:1,voicePitch:1,voiceVolume:1,theme:"dark",fontSize:"medium",showDebugLog:!1,behaviorDetectionEnabled:!0,proactiveGuidance:!0,strictBrowserAgentMode:!1,preferredRetailer:"any",enableScreenshotTool:!0}}if((c===L.CDP_SCREENSHOT||c===L.CAPTURE_SCREENSHOT)&&!w.enableScreenshotTool)throw new Error("Screenshot tool is disabled in settings");switch(c){case L.GET_USER_PROFILE:{const l=Le.getInstance();return await l.ensureInitialized(),await l.getProfile()}case L.FIND_FORM_FIELDS:{try{const m=await chrome.tabs.get(e);if(!m.url||m.url.startsWith("chrome://")||m.url.startsWith("chrome-extension://")||m.url.startsWith("about:"))return{success:!1,error:"Cannot scan this page. Please navigate to a website first."}}catch{return{success:!1,error:"Could not access the current tab. Please try again."}}return((X=(await chrome.scripting.executeScript({target:{tabId:e},world:"MAIN",func:()=>{const m=[];return document.querySelectorAll('input:not([type="hidden"]):not([type="password"]), select, textarea').forEach(T=>{var I,E;const M=T;let k="";if(M.id){const R=document.querySelector(`label[for="${M.id}"]`);R&&(k=((I=R.textContent)==null?void 0:I.trim())||"")}if(!k){const R=M.closest("label");if(R){const N=R.cloneNode(!0);N.querySelectorAll("input, select, textarea").forEach(d=>d.remove()),k=((E=N.textContent)==null?void 0:E.trim())||""}}m.push({tagName:M.tagName,type:M.type,name:M.name||void 0,id:M.id||void 0,placeholder:M.getAttribute("placeholder")||void 0,label:k||void 0})}),m}}))[0])==null?void 0:X.result)||[]}case L.MAP_FIELDS_TO_PROFILE:{const l=Le.getInstance();await l.ensureInitialized();const m=await l.getProfile(),S=new lt,T=i.fields;return{mapping:S.mapFields(T,m)}}case L.CONFIRM_FILLED_FIELDS:return(await a.sendToTab(e,f.EXECUTE_TOOL,{name:L.CONFIRM_FILLED_FIELDS,arguments:{}})).data;case L.FILL_FORM:return(await a.sendToTab(e,f.EXECUTE_TOOL,{name:L.FILL_FORM,arguments:i})).data;case L.CDP_NAVIGATE:return await t.navigate(e,i.url),{navigated:!0,url:i.url};case L.CDP_RELOAD:return await t.reload(e),{reloaded:!0};case L.CDP_BACK:return await t.goBack(e),{navigated:!0,direction:"back"};case L.CDP_FORWARD:return await t.goForward(e),{navigated:!0,direction:"forward"};case L.CDP_CLICK:return w.strictBrowserAgentMode&&await He(e,i.selector),await ie(200,200),await t.click(e,i.selector),await ie(100,100),{clicked:!0,selector:i.selector};case L.CDP_TYPE:{const l=i.selector,m=i.text;if(ft(l))throw new Error("Cannot type into sensitive fields (passwords, credit cards, etc.)");return w.strictBrowserAgentMode&&await He(e,l),await ie(100,200),await t.type(e,l,m,{clearFirst:i.clearFirst}),await ie(50,50),{typed:!0,selector:l,textLength:m.length}}case L.CDP_SCROLL:return await t.scroll(e,i.deltaX??0,i.deltaY??300),{scrolled:!0};case L.CDP_SCROLL_TO_ELEMENT:return w.strictBrowserAgentMode&&await He(e,i.selector),await t.scrollToElement(e,i.selector,i.block),{scrolled:!0,selector:i.selector};case L.CDP_SCREENSHOT:case L.CAPTURE_SCREENSHOT:return{dataUrl:await t.captureScreenshot(e,{format:i.format,quality:i.quality})};case L.GET_PAGE_INFO:return(await a.sendToTab(e,f.GET_PAGE_STATE,{})).data;case L.GET_VISIBLE_ELEMENTS:{const m=(await a.sendToTab(e,f.GET_PAGE_STATE,{})).data,S=i.type||"all",T={buttons:(m==null?void 0:m.buttons)||[],links:(m==null?void 0:m.links)||[],inputs:(m==null?void 0:m.inputs)||[]};return S==="buttons"?{buttons:T.buttons}:S==="links"?{links:T.links}:S==="inputs"?{inputs:T.inputs}:T}case"show_visual_guid_message":case"show_visual_guidance":return await a.sendToTab(e,f.SHOW_GUIDANCE,{selector:i.selector,guidance:i.message,showArrow:i.showArrow}),{shown:!0};case"hide_visual_guidance":return await a.sendToTab(e,f.HIDE_GUIDANCE,{}),{hidden:!0};case"speak_guidance":return await s.speakGuidance(i.text),{spoken:!0};case L.WEB_SEARCH:{const l=i.query||"",m=i.site||"";let S="";const T=encodeURIComponent(l),M=/shopping/i.test(m);if(M){const d=await chrome.tabs.get(e),g=(d==null?void 0:d.url)??"",D=((ue=await F.getSettings())==null?void 0:ue.preferredRetailer)||"amazon";if(/amazon/i.test(D)){let v=/amazon\.com\.au/i.test(D)||/amazon\.com\.au/i.test(g)?"https://www.amazon.com.au/s":"https://www.amazon.com/s";const n=new URLSearchParams;n.append("k",l);const b=i.sortBy||"review-rank";b==="review-rank"?n.append("s","review-rank"):b==="price-asc"?n.append("s","price-asc-rank"):b==="price-desc"&&n.append("s","price-desc-rank"),(i.minPrice!==void 0||i.maxPrice!==void 0)&&(n.append("low-price",i.minPrice?String(i.minPrice):""),n.append("high-price",i.maxPrice?String(i.maxPrice):""),n.append("ref","sr_nr_p_36_0_0")),S=`${v}?${n.toString()}`}else/ebay/i.test(D)?S=`https://www.ebay.com/sch/i.html?_nkw=${T}`:/walmart/i.test(D)?S=`https://www.walmart.com/search/?query=${T}`:S=`https://www.amazon.com/s?k=${T}`}else{const d=w.searchUrl||"https://www.google.com/search?q=";S=d.includes("?")?`${d}${T}`:`${d}?q=${T}`}if(await t.navigate(e,S),await new Promise(d=>setTimeout(d,M?3e3:500)),M)try{/amazon/i.test(S)?(u.info("[WEB_SEARCH] Proactively injecting Amazon integration..."),await chrome.scripting.executeScript({target:{tabId:e},files:[Ge]})):/ebay/i.test(S)?(u.info("[WEB_SEARCH] Proactively injecting eBay integration..."),await chrome.scripting.executeScript({target:{tabId:e},files:[Ue]})):/walmart/i.test(S)&&(u.info("[WEB_SEARCH] Proactively injecting Walmart integration..."),await chrome.scripting.executeScript({target:{tabId:e},files:[$e]})),await new Promise(d=>setTimeout(d,500))}catch(d){u.warn("[WEB_SEARCH] Proactive injection failed (may already be loaded)",d)}let k=await a.sendToTab(e,f.GET_PAGE_STATE,{});const I=String((k==null?void 0:k.error)||"").toLowerCase();if(!k.success||I.includes("document is not defined")||I.includes("receiving end does not exist")){u.warn("Page state error detected, attempting reinject",{tabId:e,error:k.error});try{await chrome.scripting.executeScript({target:{tabId:e},world:"MAIN",func:()=>{window.__siteIntegrationPing=(window.__siteIntegrationPing||0)+1}}),/amazon/i.test(S)?await chrome.scripting.executeScript({target:{tabId:e},files:[Ge]}):/ebay/i.test(S)?await chrome.scripting.executeScript({target:{tabId:e},files:[Ue]}):/walmart/i.test(S)&&await chrome.scripting.executeScript({target:{tabId:e},files:[$e]}),await new Promise(d=>setTimeout(d,1e3)),k=await a.sendToTab(e,f.GET_PAGE_STATE,{})}catch(d){u.error("Reinject attempt failed",d)}}if(!M){const d=k.data;return{searched:!0,query:l,site:"web",pageTitle:(d==null?void 0:d.title)||"",pageUrl:S,links:((d==null?void 0:d.links)||[]).slice(0,10),pageContent:((de=d==null?void 0:d.visibleText)==null?void 0:de.substring(0,1e3))||"",message:"Page loaded. You can now browse the results or ask me to help you find specific information."}}let E=((z=k.data)==null?void 0:z.productCards)??[];const R=[];if(u.info("[WEB_SEARCH] ========== PRODUCT EXTRACTION =========="),u.info("[WEB_SEARCH] Raw product cards received:",E.length),u.info("[WEB_SEARCH] Product cards data:",JSON.stringify(E,null,2)),E.length===0){u.info("[WEB_SEARCH] No products found initially, waiting and retrying..."),await new Promise(d=>setTimeout(d,2e3));try{await t.scroll(e,0,500),await new Promise(d=>setTimeout(d,1e3))}catch(d){u.warn("[WEB_SEARCH] Scroll failed",d)}k=await a.sendToTab(e,f.GET_PAGE_STATE,{}),E=((be=k.data)==null?void 0:be.productCards)??[],u.info("[WEB_SEARCH] After 1st retry - product count:",E.length),E.length>0&&u.info("[WEB_SEARCH] Products after 1st retry:",JSON.stringify(E,null,2)),E.length===0&&(u.info("[WEB_SEARCH] Still no products, trying 2nd retry..."),await new Promise(d=>setTimeout(d,1500)),k=await a.sendToTab(e,f.GET_PAGE_STATE,{}),E=((W=k.data)==null?void 0:W.productCards)??[],u.info("[WEB_SEARCH] After 2nd retry - product count:",E.length),E.length>0&&u.info("[WEB_SEARCH] Products after 2nd retry:",JSON.stringify(E,null,2)))}if(E.length>0){u.info("[WEB_SEARCH] Processing products for LLM..."),u.info("[WEB_SEARCH] Product count before filtering:",E.length);const d=i.maxPrice;let g=E;d!==void 0&&(u.info("[WEB_SEARCH] Applying price filter: max =",d),g=E.filter(p=>p.priceNumber===null||p.priceNumber===void 0?!0:p.priceNumber<=d),u.info("[WEB_SEARCH] Candidates after price filter:",g.length)),g.length===0&&(u.warn("[WEB_SEARCH] No candidates within budget, using all products"),g=E),u.info("[WEB_SEARCH] Candidates to sort:",JSON.stringify(g.map(p=>{var _;return{title:(_=p.title)==null?void 0:_.slice(0,50),price:p.price,priceNumber:p.priceNumber,rating:p.rating,reviews:p.reviews}}),null,2));const v=[...g].sort((p,_)=>p.rating!==null&&_.rating===null?-1:p.rating===null&&_.rating!==null?1:p.rating!==null&&_.rating!==null&&_.rating!==p.rating?_.rating-p.rating:p.priceNumber!==null&&_.priceNumber!==null?p.priceNumber-_.priceNumber:0)[0],n=v.rating?`‚≠ê ${v.rating}/5 stars`:"No rating",b=v.price||"Price not available",x=v.title||"Product";u.info("[WEB_SEARCH] ========== SENDING TO LLM =========="),u.info("[WEB_SEARCH] Best product selected:"),u.info("[WEB_SEARCH] Title:",v.title),u.info("[WEB_SEARCH] Title length:",(Re=v.title)==null?void 0:Re.length),u.info("[WEB_SEARCH] Price:",v.price),u.info("[WEB_SEARCH] Price Number:",v.priceNumber),u.info("[WEB_SEARCH] Rating:",v.rating),u.info("[WEB_SEARCH] Reviews:",v.reviews),u.info("[WEB_SEARCH] Link:",v.link),u.info("[WEB_SEARCH] Data-UUID:",v["data-uuid"]),u.info("[WEB_SEARCH] Full bestProduct object:",JSON.stringify(v,null,2)),u.info("[WEB_SEARCH] Recommendation text:",`I found ${E.length} products. The best option is:

**${x}**
- Price: ${b}
- Rating: ${n}

üëâ Would you like me to add this to your cart?`),u.info("[WEB_SEARCH] ======================================");const C=/amazon\.com\.au/i.test(S)?"Amazon Australia":/amazon\./i.test(S)?"Amazon":/ebay\.com\.au/i.test(S)?"eBay Australia":/ebay\./i.test(S)?"eBay":/walmart\./i.test(S)?"Walmart":"shopping site";return{searched:!0,query:l,site:m||"shopping",retailer:C,productCount:E.length,bestProduct:v,recommendation:`I found ${E.length} products on **${C}**. The best option is:

**${x}**
- Price: ${b}
- Rating: ${n}

üëâ Would you like me to add this to your cart?`,awaitingConfirmation:!0,errors:R.length?R:void 0}}const N=/amazon\.com\.au/i.test(S)?"Amazon Australia":/amazon\./i.test(S)?"Amazon":/ebay\.com\.au/i.test(S)?"eBay Australia":/ebay\./i.test(S)?"eBay":/walmart\./i.test(S)?"Walmart":"shopping site";return{searched:!0,query:l,site:m||"shopping",retailer:N,results:E,productCount:0,message:`No products found on ${N}. Try a different search.`,errors:R.length?R:void 0}}case L.ADD_TO_CART_FROM_SEARCH:{const l=await chrome.tabs.get(e),m=(l==null?void 0:l.url)??"",S=/amazon\./i.test(m),T=/walmart\./i.test(m),M=/ebay\./i.test(m);if(!S&&!T&&!M)return{success:!1,error:"This tool only works on Amazon, eBay, or Walmart search result pages."};const k=i.productTitle,I=i.productLink;try{const R=(xe=(await chrome.scripting.executeScript({target:{tabId:e},world:"MAIN",func:(N,d,g)=>{var p;const D=N;if(g){let _=-1;for(let V=1;V<=12;V++){const K=`section > div > div:nth-child(${V}) > div > div.sans-serif.mid-gray.relative.flex.flex-column.w-100.hide-child-opacity > a > span > h3`,o=document.querySelector(K);if(o&&o.textContent&&o.textContent.toLowerCase().includes(D.toLowerCase())){_=V;break}}if(_===-1)return{success:!1,error:"Product not found in Walmart search results (checked top 12)",needsNavigation:!0};const O=`section > div > div:nth-child(${_}) > div > div.sans-serif.mid-gray.relative.flex.flex-column.w-100.hide-child-opacity > a`,G=document.querySelector(O);return{success:!1,error:"Walmart requires navigation to product page to add to cart",needsNavigation:!0,productLink:G==null?void 0:G.href}}const v=Array.from(document.querySelectorAll('[data-component-type="s-search-result"], .s-result-item, [data-cel-widget*="search_result"], .s-card-container'));let n=null;for(const _ of v){const O=_.querySelector('h2, .s-title-instructions-style, [data-cy="title"]'),G=((p=O==null?void 0:O.textContent)==null?void 0:p.trim())||"";if(G&&G.toLowerCase().includes(D.toLowerCase())){n=_;break}}if(!n)return{success:!1,error:"Product not found in search results",needsNavigation:!0};const b=['button[id*="add-to-cart"]','input[id*="add-to-cart"]','button[name="submit.addToCart"]','button[data-action="add-to-cart"]'];let x=null;for(const _ of b){const O=n.querySelector(_);if(O){x=O;break}}if(!x){const _=n.querySelectorAll('button, input[type="submit"]');for(const O of _){const G=(O.textContent||O.value||"").toLowerCase();if(G.includes("add to cart")||G.includes("add to basket")){x=O;break}}}if(x)return x.click(),{success:!0,clickedInSearchResults:!0,message:"Clicked add to cart button"};const C=n.querySelector('a[href*="/dp/"], a[href*="/itm/"], a.s-link-style');return{success:!1,error:"Add to cart button not found in search results",needsNavigation:!0,productLink:C==null?void 0:C.href}},args:[k,I??null,T]}))[0])==null?void 0:xe.result;if(R.success){if(await ie(500,300),T)return await chrome.scripting.executeScript({target:{tabId:e},func:()=>{const N=document.querySelector("#cart-button-header");N?N.click():window.location.href="https://www.walmart.com/cart"}}),{success:!0,message:"Added to cart and opened cart page."};if(S){const N=m.match(/amazon\.([a-z.]+)/i),d=N?N[1]:"com";return await t.navigate(e,`https://www.amazon.${d}/gp/cart/view.html?ref_=nav_cart`),{success:!0,message:"Added to cart and navigated to cart view."}}return{success:!0,message:"Added to cart."}}if(R.needsNavigation&&(R.productLink||I)){u.info("Navigating to product page to add to cart...");const N=R.productLink||I;if(await t.navigate(e,N),T)return await ie(3e3,0),(se=(we=(await chrome.scripting.executeScript({target:{tabId:e},func:()=>{const v=document.querySelector("#maincontent > section > main > div.flex.flex-column.h-100 > div:nth-child(2) > div > div.w_aoqv.w_wRee.w_b_WN > div > div:nth-child(1) > div > div:nth-child(2) > div > div > section:nth-child(4) > div > div > div > div > div > div > div > div > button");return v?(v.click(),{success:!0}):{success:!1,error:"Strict button selector not found"}}}))[0])==null?void 0:we.result)!=null&&se.success?(await ie(500,500),await chrome.scripting.executeScript({target:{tabId:e},func:()=>{var D;(D=document.querySelector("#cart-button-header"))==null||D.click()}}),{success:!0,message:"Added to cart from product page (Strict Protocol)."}):{success:!1,error:"Failed to find add to cart button with strict selector"};if(await ie(2e3,500),(Fe=(ae=(await chrome.scripting.executeScript({target:{tabId:e},func:g=>{const D=g?['button[data-tl-id*="cta-add-to-cart"]','button[data-automation-id="add-to-cart"]']:["#add-to-cart-button","#buy-now-button",'[name="submit.add-to-cart"]'];for(const v of D){const n=document.querySelector(v);if(n)return n.click(),{success:!0}}return{success:!1}},args:[T]}))[0])==null?void 0:ae.result)!=null&&Fe.success){if(T)await ie(500,500),await chrome.scripting.executeScript({target:{tabId:e},func:()=>{var g;(g=document.querySelector("#cart-button-header"))==null||g.click()}});else if(S){const g=m.match(/amazon\.([a-z.]+)/i),D=g?g[1]:"com";await t.navigate(e,`https://www.amazon.${D}/gp/cart/view.html?ref_=nav_cart`)}return{success:!0,message:"Added to cart from product page."}}}return{success:!1,error:R.error||"Failed to add to cart"}}catch(E){return u.error("Error in add_to_cart_from_search",E),{success:!1,error:String(E)}}}case L.ADD_TO_CART:{const l=await chrome.tabs.get(e),m=(l==null?void 0:l.url)??"";return/amazon\.|ebay\.|walmart\./i.test(m)?{forwarded:!0,result:await a.sendToTab(e,f.EXECUTE_TOOL,{name:L.ADD_TO_CART,arguments:i}).catch(()=>({success:!1,error:"Add-to-cart execution failed"}))}:{success:!1,error:"Add-to-cart can only be executed on supported shopping sites (Amazon, eBay, Walmart). I can navigate there and try again if you want."}}case L.NAVIGATE_TO_PRODUCT:return{forwarded:!0,result:await a.sendToTab(e,f.EXECUTE_TOOL,{name:L.NAVIGATE_TO_PRODUCT,arguments:i}).catch(()=>({success:!1,error:"Product navigation execution failed"}))};case L.NAVIGATE_TO_PRODUCT_SPECS:{const l=await chrome.tabs.get(e),m=(l==null?void 0:l.url)??"";return/amazon\.|ebay\.|walmart\./i.test(m)?{forwarded:!0,result:await a.sendToTab(e,f.EXECUTE_TOOL,{name:L.NAVIGATE_TO_PRODUCT_SPECS,arguments:i}).catch(()=>({success:!1,error:"Navigation to product specs failed"}))}:{success:!1,error:"This tool only works on shopping sites (Amazon, eBay, Walmart)."}}case L.ADD_TO_CART_FROM_PRODUCT_PAGE:{const l=await chrome.tabs.get(e),m=(l==null?void 0:l.url)??"";return/amazon\.|ebay\.|walmart\./i.test(m)?{forwarded:!0,result:await a.sendToTab(e,f.EXECUTE_TOOL,{name:L.ADD_TO_CART_FROM_PRODUCT_PAGE,arguments:i}).catch(()=>({success:!1,error:"Add-to-cart from product page execution failed"}))}:{success:!1,error:"Add-to-cart can only be executed on supported shopping sites (Amazon, eBay, Walmart)."}}case L.NAVIGATE_TO_CART:{const l=await chrome.tabs.get(e),S=((l==null?void 0:l.url)??"").match(/amazon\.([a-z.]+)/i),T=S?S[1]:"com",M=`https://www.amazon.${T}/gp/cart/view.html?ref_=nav_cart`;u.debug("Navigating to cart",{cartUrl:M,domain:T});try{return await t.sendCommand(e,"Page.navigate",{url:M}),{success:!0,data:{navigatedToCart:!0,url:M}}}catch(k){return u.error("Failed to navigate to cart",k),{success:!1,error:"Failed to navigate to cart"}}}case L.EXECUTE_CHECKOUT:{const l=await chrome.tabs.get(e),m=(l==null?void 0:l.url)??"";if(!/\/gp\/cart\/|\/cart\//i.test(m))return{success:!1,error:"Not on cart page. Please navigate to cart first using navigate_to_cart."};const S=["#sc-buy-box-ptc-button > span > input",'input[name="proceedToRetailCheckout"]','input[name="proceedToCheckout"]',"#sc-buy-box-ptc-button input"];try{for(const T of S)try{const M=await t.sendCommand(e,"DOM.getDocument",{}),k=await t.sendCommand(e,"DOM.querySelector",{nodeId:M.root.nodeId,selector:T});if(k.nodeId&&k.nodeId!==0){const I=await t.sendCommand(e,"DOM.getBoxModel",{nodeId:k.nodeId});if(I.model){const E=I.model.content[0]+(I.model.content[2]-I.model.content[0])/2,R=I.model.content[1]+(I.model.content[5]-I.model.content[1])/2;return await t.sendCommand(e,"Input.dispatchMouseEvent",{type:"mousePressed",x:E,y:R,button:"left",clickCount:1}),await t.sendCommand(e,"Input.dispatchMouseEvent",{type:"mouseReleased",x:E,y:R,button:"left",clickCount:1}),u.debug("Clicked checkout button",{selector:T,x:E,y:R}),{success:!0,data:{clicked:T}}}}}catch{continue}return{success:!1,error:"Checkout button not found on page. Make sure the cart has items."}}catch(T){return u.error("Failed to click checkout button",T),{success:!1,error:"Failed to click checkout button"}}}case L.DETECT_PRODUCT_CARDS:{const l=await chrome.tabs.get(e),m=(l==null?void 0:l.url)??"";if(!/amazon\.|ebay\.|walmart\./i.test(m))return{success:!1,error:"This tool only works on shopping sites (Amazon, eBay, Walmart). Please navigate to a search results page first.",products:[]};const T=((Ee=(await a.sendToTab(e,f.GET_PAGE_STATE,{})).data)==null?void 0:Ee.productCards)??[];return{success:!0,products:T,count:T.length,message:T.length>0?`Found ${T.length} products on the page.`:"No products found. Try scrolling or searching again."}}case L.SELECT_BEST_PRODUCT:{const l=i.maxPrice,m=await chrome.tabs.get(e),S=(m==null?void 0:m.url)??"";if(!/amazon\.|ebay\.|walmart\./i.test(S))return{success:!1,error:"This tool only works on shopping sites (Amazon, eBay, Walmart).",product:null};const M=((Ce=(await a.sendToTab(e,f.GET_PAGE_STATE,{})).data)==null?void 0:Ce.productCards)??[];if(M.length===0)return{success:!1,error:"No products found on the page. Try searching first.",product:null};let k=M;if(l!==void 0&&(k=M.filter(d=>d.priceNumber===null||d.priceNumber===void 0?!0:d.priceNumber<=l)),k.length===0){const g=[...M].sort((D,v)=>D.priceNumber===null?1:v.priceNumber===null?-1:D.priceNumber-v.priceNumber)[0];return{success:!1,error:`No products found within $${l}. The cheapest option is ${g==null?void 0:g.title} at ${g==null?void 0:g.price}.`,product:g,overBudget:!0}}const I=[...k].sort((d,g)=>d.rating!==null&&g.rating===null?-1:d.rating===null&&g.rating!==null?1:d.rating!==null&&g.rating!==null&&g.rating!==d.rating?g.rating-d.rating:d.priceNumber!==null&&g.priceNumber!==null?d.priceNumber-g.priceNumber:0),E=I[0],R=E.rating?` ‚Äî ‚≠ê ${E.rating}/5`:"",N=`Found: "${(De=E.title)==null?void 0:De.slice(0,60)}..." ‚Äî ${E.price}${R}. Would you like me to add this to your cart?`;return{success:!0,product:E,confirmationMessage:N,alternativeCount:I.length-1}}case L.DETECT_FORM_FIELDS:{const l=i.formSelector,S=(ce=(await chrome.scripting.executeScript({target:{tabId:e},world:"MAIN",func:T=>{const M=T,k=[],I=[],E=[],R=M?document.querySelector(M):document;if(!R)return{error:"Form not found"};E.push("Step 1: Scanning visible page content..."),R.querySelectorAll("h1, h2, h3, h4, h5, h6, p, span, label, legend, th, td, li, a, button, div").forEach(D=>{var b;const v=D.getBoundingClientRect(),n=window.getComputedStyle(D);if(v.width>0&&v.height>0&&n.display!=="none"&&n.visibility!=="hidden"&&parseFloat(n.opacity)>0){const x=(b=D.textContent)==null?void 0:b.trim();x&&x.length>0&&x.length<500&&x.length>2&&!I.includes(x)&&I.push(x)}}),E.push("Found "+I.length+" visible text elements"),E.push("Step 2: Scanning form elements..."),R.querySelectorAll("input, select, textarea").forEach((D,v)=>{var V,K,o,h,H,B,A,$;const n=D;if(n.type==="hidden"||n.type==="password")return;const b=n.getBoundingClientRect(),x=window.getComputedStyle(n),C=b.width>0&&b.height>0&&x.display!=="none"&&x.visibility!=="hidden";let p="";const _=n.id,O=n.name;if(_){const y=document.querySelector(`label[for="${_}"]`);y&&(p=((V=y.textContent)==null?void 0:V.trim())||"")}if(!p){const y=n.closest("label");if(y){const U=y.cloneNode(!0);U.querySelectorAll("input, select, textarea").forEach(q=>q.remove()),p=((K=U.textContent)==null?void 0:K.trim())||""}}if(!p&&(n.type==="checkbox"||n.type==="radio")){const y=n.parentElement;if(y){const U=y.cloneNode(!0);U.querySelectorAll("input").forEach(Z=>Z.remove());const q=(o=U.textContent)==null?void 0:o.trim();q&&q.length<200&&(p=q)}if(!p){const U=n.nextSibling;U&&U.nodeType===Node.TEXT_NODE&&(p=((h=U.textContent)==null?void 0:h.trim())||""),!p&&n.nextElementSibling&&(p=((H=n.nextElementSibling.textContent)==null?void 0:H.trim())||"")}}if(!p&&n.type==="radio"){const y=n.closest("fieldset");if(y){const U=y.querySelector("legend");U&&(p=((B=U.textContent)==null?void 0:B.trim())+": "+((($=(A=n.nextSibling)==null?void 0:A.textContent)==null?void 0:$.trim())||n.value||""))}}p||(p=n.getAttribute("placeholder")||n.getAttribute("aria-label")||""),!p&&O&&(p=O.replace(/([A-Z])/g," $1").replace(/_/g," ").trim());const G={index:v,type:n.tagName.toLowerCase(),inputType:n.type||"text",label:p,name:O,id:_,placeholder:n.getAttribute("placeholder"),value:n.type==="checkbox"||n.type==="radio"?n.checked?"checked":"unchecked":n.value,checked:n.type==="checkbox"||n.type==="radio"?n.checked:void 0,required:n.hasAttribute("required"),disabled:n.disabled,isVisible:C,selector:_?`#${_}`:O?`[name="${O}"]${n.type==="radio"?`[value="${n.value}"]`:""}`:null};n.tagName==="SELECT"&&(G.options=Array.from(n.options).map(y=>{var U;return{value:y.value,text:(U=y.textContent)==null?void 0:U.trim(),selected:y.selected}})),k.push(G)});const g={};return k.forEach(D=>{D.inputType==="radio"&&D.name&&(g[D.name]||(g[D.name]=[]),g[D.name].push(D))}),E.push("Found "+k.length+" form fields"),E.push("Found "+Object.keys(g).length+" radio button groups"),{success:!0,visibleContent:I.slice(0,50),fields:k,totalFields:k.length,radioGroups:Object.keys(g).length>0?g:void 0,logs:E}},args:[l??null]}))[0])==null?void 0:ce.result;return S||{success:!1,error:"Failed to execute detect form fields script on the page."}}case L.AUTO_FILL_FORM:{const l=i.formSelector,m=i.submitAfter;try{const E=await chrome.tabs.get(e);if(!E.url||E.url.startsWith("chrome://")||E.url.startsWith("chrome-extension://")||E.url.startsWith("about:"))return{success:!1,error:"Cannot autofill on this page. Please navigate to a website first."}}catch{return{success:!1,error:"Could not access the current tab. Please try again."}}const T=await Ye.getInstance().getPersonalData();if(u.info("AUTO_FILL_FORM: Retrieved personal data",{hasData:!!T,fieldCount:T?Object.keys(T).length:0,fields:T?Object.keys(T):[]}),!T||Object.keys(T).length===0)return u.warn("AUTO_FILL_FORM: No personal data found"),{success:!1,error:"No personal data found. Please configure your personal information in settings first."};u.info("AUTO_FILL_FORM: Starting form fill",{formSelector:l||"entire page",submitAfter:m,personalData:JSON.stringify(T),hasEmail:!!T.email,emailValue:T.email?T.email.substring(0,10)+"...":"none"});const k=(Se=(await chrome.scripting.executeScript({target:{tabId:e},world:"MAIN",func:(E,R,N)=>{const d=E,g=R,D=N,v=[],n=[];function b(o,h){var H,B;try{n.push("üéØ Attempting to fill: "+(o.name||o.id||"unknown")+" with: "+h.substring(0,30));const A=(H=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:H.set,$=(B=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:B.set;o.focus(),o instanceof HTMLInputElement&&A?A.call(o,h):o instanceof HTMLTextAreaElement&&$?$.call(o,h):o.value=h,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}));for(let y=0;y<5;y++){const U=Date.now();for(;Date.now()-U<100;);if(o.value===h)return n.push("  ‚úì Value confirmed after "+(y+1)+" checks"),o.value;n.push("  ‚ö† Value cleared, attempt "+(y+2)+" to set it"),o instanceof HTMLInputElement&&A?A.call(o,h):o instanceof HTMLTextAreaElement&&$?$.call(o,h):o.value=h,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}))}return o.value}catch(A){return n.push("‚úó Error filling input: "+String(A)),""}}n.push("Scanning visible page content first...");const x=[];document.querySelectorAll("h1, h2, h3, h4, h5, h6, p, span, label, legend, th, td").forEach(o=>{var B;const h=o.getBoundingClientRect(),H=window.getComputedStyle(o);if(h.width>0&&h.height>0&&H.display!=="none"){const A=(B=o.textContent)==null?void 0:B.trim();A&&A.length>2&&A.length<200&&x.push(A.toLowerCase())}}),n.push("Found "+x.length+" visible text elements"),n.push("Starting auto-fill process..."),n.push("Personal data keys: "+Object.keys(d).join(", "));const C=g?document.querySelector(g):document;if(!C)return n.push("ERROR: Container not found"),{success:!1,filledFields:0,totalFields:0,results:[],logs:n,error:"Form container not found"};n.push("=== FORM FIELD INVENTORY ===");const p=C.querySelectorAll('input:not([type="hidden"]):not([type="password"]):not([type="submit"]):not([type="button"]):not([type="image"]), select, textarea');n.push("Total visible inputs found: "+p.length);const _=[];if(p.forEach((o,h)=>{var y,U;const H=o,B=H.getBoundingClientRect(),A=window.getComputedStyle(H);if(B.width>0&&B.height>0&&A.display!=="none"&&A.visibility!=="hidden"&&parseFloat(A.opacity)>0){const q=H.type||H.tagName.toLowerCase(),Z=H.name||"(no name)",fe=H.id||"(no id)",ve=H.getAttribute("placeholder")||"(no placeholder)";let me="";if(H.id){const Y=document.querySelector(`label[for="${H.id}"]`);Y&&(me=((y=Y.textContent)==null?void 0:y.trim())||"")}if(!me){const Y=H.closest("label");if(Y){const ne=Y.cloneNode(!0);ne.querySelectorAll("input, select, textarea").forEach(Q=>Q.remove()),me=((U=ne.textContent)==null?void 0:U.trim())||""}}me=me||"(no label)";const ee=h+": type="+q+", name="+Z+", id="+fe+", label="+me.substring(0,30)+", placeholder="+ve.substring(0,30);_.push(ee),n.push("  Field "+ee)}}),_.length===0)return n.push("‚ö†Ô∏è WARNING: No visible form fields found on page!"),{success:!1,filledFields:0,totalFields:0,results:[],logs:n,error:"No visible form fields found on the page"};n.push("=== STARTING FIELD MATCHING AND FILLING ===");const O={firstName:["firstname","first_name","givenname","given_name","fname"],lastName:["lastname","last_name","familyname","family_name","surname","lname"],fullName:["fullname","full_name","customername","customer_name","contactname","contact_name"],email:["email","emailaddress","email_address","useremail","user_email","contactemail"],phone:["phone","phonenumber","phone_number","telephone","mobile","mobilenumber","tel","cellphone"],dateOfBirth:["dateofbirth","date_of_birth","birthdate","birth_date","dob","birthday"],address:["addressline1","address_line_1","address1","streetaddress","street_address","address"],city:["city","town","locality","suburb"],state:["state","province","region","territory"],zipCode:["zipcode","zip_code","postalcode","postal_code","postcode","post_code","zip"],country:["country","countryregion","country_region","nation"]};function G(o){var A;const h=g?document.querySelector(g):document;if(!h)return n.push("ERROR: Container not found for selector: "+g),null;const H=h.querySelectorAll('input:not([type="hidden"]):not([type="password"]):not([type="submit"]):not([type="button"]):not([type="image"]), select, textarea');n.push("üîç Searching "+H.length+" inputs for: "+o.join(", "));let B=null;for(const $ of o){const y=$.toLowerCase().replace(/[_-\s]/g,"");for(const U of H){const q=U,Z=((A=q.type)==null?void 0:A.toLowerCase())||"text";if(Z==="checkbox"||Z==="radio")continue;const fe=q.getBoundingClientRect(),ve=window.getComputedStyle(q);if(!(fe.width>0&&fe.height>0&&ve.display!=="none"&&ve.visibility!=="hidden"&&parseFloat(ve.opacity)>0))continue;const ee=(q.name||"").toLowerCase().replace(/[_-\s]/g,""),Y=(q.id||"").toLowerCase().replace(/[_-\s]/g,"");(q.getAttribute("placeholder")||"").toLowerCase().replace(/[_-\s]/g,""),(q.getAttribute("aria-label")||"").toLowerCase().replace(/[_-\s]/g,"");const ne=(q.getAttribute("autocomplete")||"").toLowerCase().replace(/[_-\s]/g,"");let Q="";if(q.id){const Ae=document.querySelector(`label[for="${q.id}"]`);Ae&&(Q=(Ae.textContent||"").toLowerCase().trim().replace(/[_-\s*:]/g,""))}if(!Q){const Ae=q.closest("label");if(Ae){const qe=Ae.cloneNode(!0);qe.querySelectorAll("input, select, textarea").forEach(Je=>Je.remove()),Q=(qe.textContent||"").toLowerCase().trim().replace(/[_-\s*:]/g,"")}}let j=0,te="",re="";Z==="email"&&y.includes("email")?(j=100,te="type=email",re="type="+Z):Z==="tel"&&(y.includes("phone")||y.includes("tel"))?(j=100,te="type=tel",re="type="+Z):ne&&ne===y?(j=95,te="autocomplete exact",re="autocomplete="+ne):ee&&ee===y?(j=90,te="name exact",re="name="+ee):Y&&Y===y?(j=90,te="id exact",re="id="+Y):Q&&Q===y?(j=85,te="label exact",re="label="+Q):ee&&ee.length>=8&&y.length>=5&&ee.includes(y)?y==="name"&&(ee.includes("user")||ee.includes("login"))?j=0:(j=75,te="name contains (strict)",re="name="+ee+" contains "+y):Y&&Y.length>=8&&y.length>=5&&Y.includes(y)?y==="name"&&(Y.includes("user")||Y.includes("login"))?j=0:(j=70,te="id contains (strict)",re="id="+Y+" contains "+y):Q&&Q.length>=8&&y.length>=5&&Q.includes(y)?y==="name"&&(Q.includes("user")||Q.includes("login"))?j=0:(j=65,te="label contains (strict)",re="label="+Q+" contains "+y):ne&&ne.length>=6&&y.length>=5&&ne.includes(y)&&(j=60,te="autocomplete contains",re="autocomplete="+ne),j>=65&&(!B||j>B.score)&&(B={input:q,score:j,reason:te,matchDetails:re})}}return B?(n.push("‚úì MATCH ("+B.reason+", score="+B.score+"): "+o[0]+" -> "+B.matchDetails),B.input):(n.push("‚úó NO MATCH for: "+o.join(", ")+" (no confident match found)"),null)}function V(o,h,H){var y,U,q;const B=((y=o.type)==null?void 0:y.toLowerCase())||"text",A=((U=o.name)==null?void 0:U.toLowerCase())||"",$=((q=o.id)==null?void 0:q.toLowerCase())||"";if(h==="email"){if(B==="password"||A.includes("password")||$.includes("password"))return n.push("‚ùå REJECTED: email field has type/name password"),!1;if((A.includes("phone")||A.includes("tel"))&&!A.includes("email"))return n.push("‚ùå REJECTED: email field appears to be for phone"),!1;if((A.includes("firstname")||A.includes("lastname")||A.includes("name"))&&!A.includes("email"))return n.push("‚ùå REJECTED: email field appears to be for name"),!1}if(h==="phone"&&(B==="email"||A.includes("email")||$.includes("email")))return n.push("‚ùå REJECTED: phone field has type/name email"),!1;if(h==="firstName"||h==="lastName"||h==="fullName"){if(B==="email"||B==="tel"||B==="number")return n.push("‚ùå REJECTED: name field has wrong type: "+B),!1;if(A.includes("email")||$.includes("email"))return n.push("‚ùå REJECTED: name field appears to be for email"),!1;if(A.includes("phone")||A.includes("tel"))return n.push("‚ùå REJECTED: name field appears to be for phone"),!1}return!0}for(const[o,h]of Object.entries(d)){if(!h){n.push("Skipping empty data key: "+o);continue}if(n.push("üìù Processing data key: "+o+" = "+String(h).substring(0,20)+"..."),o==="customFields"&&typeof h=="object"){for(const[$,y]of Object.entries(h)){if(!y)continue;n.push("Custom field: "+$+" = "+y);const U=G([$]);U&&(b(U,y)?(n.push('FILLED custom field "'+$+'"'),v.push({field:$,value:y,filled:!0})):(n.push('FAILED to fill custom field "'+$+'"'),v.push({field:$,value:y,filled:!1,reason:"Fill failed"})))}continue}const H=O[o]||[o];let B=!1,A=null;for(let $=1;$<=3;$++){if(A=G(H),!A){n.push("Attempt "+$+': Field not found for "'+o+'"');continue}if(!V(A,o)){n.push('‚ùå Field type validation FAILED for "'+o+'" - skipping to prevent hallucination'),v.push({field:o,value:String(h),filled:!1,reason:"Field type mismatch (prevented wrong field fill)"});break}if(A.tagName==="SELECT"){const y=A,q=Array.from(y.options).find(Z=>{var fe;return Z.value.toLowerCase()===String(h).toLowerCase()||((fe=Z.textContent)==null?void 0:fe.toLowerCase().includes(String(h).toLowerCase()))});if(q){y.value=q.value,y.dispatchEvent(new Event("change",{bubbles:!0})),y.dispatchEvent(new Event("input",{bubbles:!0})),B=!0,n.push('‚úì FILLED SELECT "'+o+'" with option: '+q.textContent),v.push({field:o,value:String(h),filled:!0});break}}else{b(A,String(h)),n.push("  ‚Üí Waiting 500ms for framework to process...");const y=A.value;if(y===String(h)){n.push('‚úì FILLED "'+o+'" successfully on attempt '+$),n.push('  ‚Üí Value verified: "'+y.substring(0,30)+'"'),v.push({field:o,value:String(h),filled:!0,inputName:A.name,inputId:A.id}),B=!0,A.dispatchEvent(new Event("blur",{bubbles:!0})),A.blur();break}else n.push("‚úó Attempt "+$+' failed for "'+o+'"'),n.push('  ‚Üí Expected: "'+String(h).substring(0,30)+'"'),n.push('  ‚Üí Got: "'+y.substring(0,30)+'"'),$<3&&$===2&&(n.push("  ‚Üí Trying fallback: direct value assignment"),A.value=String(h),A.dispatchEvent(new Event("input",{bubbles:!0})),A.dispatchEvent(new Event("change",{bubbles:!0})))}}B||(A?(n.push('‚úó FAILED: Could not fill "'+o+'" after 3 attempts'),v.push({field:o,value:String(h),filled:!1,reason:"Fill failed after 3 retries"})):(n.push('‚úó FAILED: Field "'+o+'" not found after 3 attempts'),v.push({field:o,value:String(h),filled:!1,reason:"Field not found on page"})))}n.push("=== FINAL VERIFICATION SWEEP ==="),n.push("Waiting 600ms for frameworks to settle...");let K=0;for(const o of v.filter(h=>h.filled)){if(!o.field||o.action==="submit")continue;const h=O[o.field]||[o.field],H=G(h);H?o.value&&H.value!==o.value?(o.filled=!1,o.reason="Value cleared after fill (ghost field)",K++,n.push("üëª GHOST: "+o.field+' - expected "'+o.value+'", found "'+H.value+'"')):o.value&&H.value===o.value&&n.push("‚úì VERIFIED: "+o.field+' = "'+o.value.substring(0,30)+'"'):(o.filled=!1,o.reason="Field disappeared from DOM (ghost)",K++,n.push("üëª GHOST: "+o.field+" - field no longer exists"))}if(n.push("=== FINAL RESULTS ==="),n.push("Total fields attempted: "+v.length),n.push("Successfully filled: "+v.filter(o=>o.filled).length),n.push("Failed to fill: "+v.filter(o=>{var h;return!o.filled&&!((h=o.reason)!=null&&h.includes("ghost"))}).length),n.push("Ghost fields detected: "+K),D){n.push("Attempting to submit form...");const o=g?document.querySelector(g):document.querySelector("form");o&&(o.submit(),n.push("Form submitted successfully"),v.push({field:"form",action:"submit",success:!0,filled:!0}))}return{success:!0,filledFields:v.filter(o=>o.filled).length,totalFields:v.length,results:v,logs:n}},args:[T,l??null,m??null]}))[0])==null?void 0:Se.result;if(!k)return{success:!1,error:"Failed to execute autofill script on the page."};const I=k;return u.info("AUTO_FILL_FORM: Completed",{success:I.success,filledFields:I.filledFields,totalFields:I.totalFields,emailFilled:((pe=I.results.find(E=>E.field==="email"))==null?void 0:pe.filled)??!1,ghostFieldsDetected:I.results.filter(E=>{var R;return(R=E.reason)==null?void 0:R.includes("ghost")}).length,results:I.results,logs:I.logs}),I}case L.FILL_FORM:{const l=i.fields,m=i.submitAfter,T=(Ne=(await chrome.scripting.executeScript({target:{tabId:e},world:"MAIN",func:(M,k)=>{var D,v,n;const I=M,E=k,R=[],N=[];N.push("Scanning visible page content first...");const d=[];document.querySelectorAll("h1, h2, h3, h4, h5, h6, p, span, label, legend, th, td").forEach(b=>{var p;const x=b.getBoundingClientRect(),C=window.getComputedStyle(b);if(x.width>0&&x.height>0&&C.display!=="none"){const _=(p=b.textContent)==null?void 0:p.trim();_&&_.length>2&&_.length<200&&d.push(_.toLowerCase())}}),N.push("Found "+d.length+" visible text elements");function g(b){var O,G,V,K;const x=b.toLowerCase().trim();N.push('Looking for field: "'+x+'"');let C=document.querySelector(`input[name="${b}"]:not([type="hidden"]):not([type="password"])`);if(C)return N.push("Found by exact name match: "+b),C;const p=Array.from(document.querySelectorAll('input:not([type="hidden"]):not([type="password"]), select, textarea'));for(const o of p){const h=((O=o.name)==null?void 0:O.toLowerCase())||"";if(h&&(h.includes(x)||x.includes(h)))return N.push("Found by name contains: "+o.name),o}if(C=document.getElementById(b),C&&C.type!=="hidden"&&C.type!=="password")return N.push("Found by ID: "+b),C;for(const o of p){const h=((G=o.id)==null?void 0:G.toLowerCase())||"";if(h&&(h.includes(x)||x.includes(h)))return N.push("Found by ID contains: "+o.id),o}if(C=document.querySelector(`[placeholder*="${b}" i]:not([type="hidden"]):not([type="password"])`),C)return N.push("Found by placeholder: "+b),C;const _=Array.from(document.querySelectorAll("label"));for(const o of _){const h=((V=o.textContent)==null?void 0:V.trim().toLowerCase())||"";if(h.includes(x)||x.includes(h.split(":")[0].trim())){const H=o.getAttribute("for");if(H&&(C=document.getElementById(H),C&&C.type!=="hidden"&&C.type!=="password"))return N.push("Found by label (for): "+h),C;const B=o.querySelector('input:not([type="hidden"]):not([type="password"]), select, textarea');if(B)return N.push("Found input inside label: "+h),B}}if(C=document.querySelector(`[aria-label*="${b}" i]:not([type="hidden"]):not([type="password"])`),C)return N.push("Found by aria-label: "+b),C;for(const o of p)if(o.type==="checkbox"||o.type==="radio"){const h=o.parentElement;if(h){const H=((K=h.textContent)==null?void 0:K.toLowerCase().trim())||"";if(H.includes(x))return N.push("Found checkbox/radio by parent text: "+H.substring(0,50)),o}}return N.push("Field NOT FOUND: "+b),null}for(const[b,x]of Object.entries(I)){const C=g(b);if(!C){R.push({field:b,success:!1,error:"Field not found"});continue}if(C.type==="checkbox"){const p=["check","checked","true","yes","1","on"].includes(x.toLowerCase()),_=["uncheck","unchecked","false","no","0","off"].includes(x.toLowerCase());p&&!C.checked?(C.click(),N.push("Checked checkbox: "+b),R.push({field:b,success:!0,action:"checked"})):_&&C.checked?(C.click(),N.push("Unchecked checkbox: "+b),R.push({field:b,success:!0,action:"unchecked"})):(N.push("Checkbox already in desired state: "+b),R.push({field:b,success:!0,action:"no change needed"}))}else if(C.type==="radio"){const p=document.querySelectorAll(`input[type="radio"][name="${C.name}"]`);let _=!1;for(const O of p){const G=((v=(D=O.parentElement)==null?void 0:D.textContent)==null?void 0:v.toLowerCase().trim())||O.value.toLowerCase();if(O.value.toLowerCase()===x.toLowerCase()||G.includes(x.toLowerCase())||x.toLowerCase().includes(G)){O.click(),N.push("Selected radio: "+O.value),R.push({field:b,success:!0,selectedValue:O.value}),_=!0;break}}_||R.push({field:b,success:!1,error:"No matching radio option for: "+x})}else if(C.tagName==="SELECT"){const p=C,_=Array.from(p.options);let O=!1;for(const G of _){const V=((n=G.textContent)==null?void 0:n.trim().toLowerCase())||"",K=G.value.toLowerCase(),o=x.toLowerCase();if(V.includes(o)||o.includes(V)||K.includes(o)||o.includes(K)||V===o||K===o){p.value=G.value,p.dispatchEvent(new Event("change",{bubbles:!0})),O=!0,N.push("Selected dropdown option: "+G.textContent),R.push({field:b,success:!0,selectedOption:G.textContent||void 0});break}}O||R.push({field:b,success:!1,error:"No matching option found",availableOptions:_.map(G=>{var V;return((V=G.textContent)==null?void 0:V.trim())||""}).slice(0,10)})}else C.value=x,C.dispatchEvent(new Event("input",{bubbles:!0})),C.dispatchEvent(new Event("change",{bubbles:!0})),N.push("Filled text input: "+b+" = "+x),R.push({field:b,success:!0,value:x})}if(E){const b=document.querySelector("form");b&&(b.submit(),N.push("Form submitted"),R.push({action:"submit",success:!0}))}return{success:!0,results:R,filledCount:R.filter(b=>b.success).length,logs:N}},args:[l,m??null]}))[0])==null?void 0:Ne.result;return T||{success:!1,error:"Failed to execute fill form script on the page."}}case L.SELECT_DROPDOWN:{const l=i.selector,m=i.label,S=i.value,M=(Pe=(await chrome.scripting.executeScript({target:{tabId:e},world:"MAIN",func:(k,I,E)=>{var n,b,x;const R=k,N=I,d=E;let g=null;if(R)g=document.querySelector(R);else if(N){const C=Array.from(document.querySelectorAll("label"));for(const p of C)if((((n=p.textContent)==null?void 0:n.trim().toLowerCase())||"").includes(N.toLowerCase())){const O=p.getAttribute("for");if(O?g=document.getElementById(O):g=p.querySelector("select"),g)break}}if(!g)return{success:!1,error:"Dropdown not found"};if(g.tagName!=="SELECT")return{success:!1,error:"Element is not a dropdown"};const D=Array.from(g.options);let v=null;for(const C of D){const p=((b=C.textContent)==null?void 0:b.trim().toLowerCase())||"",_=C.value.toLowerCase(),O=d.toLowerCase();if(p===O||_===O||p.includes(O)||O.includes(p)){g.value=C.value,g.dispatchEvent(new Event("change",{bubbles:!0})),g.dispatchEvent(new Event("input",{bubbles:!0})),v=((x=C.textContent)==null?void 0:x.trim())||null;break}}return v?{success:!0,selectedOption:v,value:g.value}:{success:!1,error:"No matching option found",availableOptions:D.map(C=>{var p;return(p=C.textContent)==null?void 0:p.trim()})}},args:[l??null,m??null,S]}))[0])==null?void 0:Pe.result;return M||{success:!1,error:"Failed to execute select dropdown script on the page."}}default:return u.warn(`Unknown tool: ${c}`),{error:`Unknown tool: ${c}`}}}async function pt(e){const{messaging:r}=oe();try{u.info("[ForceComplete] Starting force complete for shopping task",{tabId:e});const t=await r.sendToTab(e,f.GET_PAGE_STATE,{});if(!t.success||!t.data)return u.warn("[ForceComplete] Failed to get page state",{tabId:e}),{success:!1,error:"Could not detect page state"};const s=t.data,a=s.productCards||[],c=s.url||"";if(u.debug("[ForceComplete] Page state detected",{url:c,productCardsCount:a.length,pageType:s.pageType}),!/amazon\.|ebay\.|walmart\./i.test(c))return u.warn("[ForceComplete] Not on a supported shopping site",{url:c}),{success:!1,error:"Force complete only works on supported shopping sites (Amazon, eBay, Walmart)"};if(a.length===0)return u.warn("[ForceComplete] No products detected on page",{url:c}),{success:!1,error:"No products detected on this page"};const i=a[0],F=i.isDetailPage===!0;if(u.info("[ForceComplete] Product context detected",{isDetailPage:F,productTitle:i.title,hasAddToCartSelector:!!i.addToCartSelector,hasLink:!!i.link}),F){u.info("[ForceComplete] Product detail page detected, executing ADD_TO_CART");const w=await r.sendToTab(e,f.EXECUTE_TOOL,{name:L.ADD_TO_CART,arguments:{selector:i.selector,link:i.link}});return u.info("[ForceComplete] ADD_TO_CART executed",{success:w.success}),{success:w.success,action:"add_to_cart_pdp",product:{title:i.title,price:i.price},result:w.data}}else if(u.info("[ForceComplete] Search results page detected"),i.addToCartSelector){u.info("[ForceComplete] Add-to-cart selector available, executing ADD_TO_CART_FROM_SEARCH");const w=await r.sendToTab(e,f.EXECUTE_TOOL,{name:L.ADD_TO_CART_FROM_SEARCH,arguments:{productTitle:i.title,productLink:i.link,addToCartSelector:i.addToCartSelector}});return u.info("[ForceComplete] ADD_TO_CART_FROM_SEARCH executed",{success:w.success}),{success:w.success,action:"add_to_cart_srp",product:{title:i.title,price:i.price},result:w.data}}else{if(u.info("[ForceComplete] No add-to-cart from search, navigating to product page"),!i.link)return u.warn("[ForceComplete] First product has no link",{title:i.title}),{success:!1,error:"First product has no link to navigate to"};const w=await r.sendToTab(e,f.EXECUTE_TOOL,{name:L.NAVIGATE_TO_PRODUCT,arguments:{link:i.link}});return u.info("[ForceComplete] NAVIGATE_TO_PRODUCT executed",{success:w.success}),{success:w.success,action:"navigate_to_product",product:{title:i.title,price:i.price},result:w.data}}}catch(t){return u.error("[ForceComplete] Error during force complete",t),{success:!1,error:t instanceof Error?t.message:"Force complete failed"}}}function ft(e){const r=e.toLowerCase();return st.some(t=>r.includes(t))}async function Oe(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return e==null?void 0:e.id}if(typeof document>"u"){const e=()=>{const r={appendChild:()=>r,removeChild:()=>r,insertBefore:()=>r,replaceChild:()=>r,cloneNode:()=>e(),addEventListener:()=>{},removeEventListener:()=>{},dispatchEvent:()=>!0,setAttribute:()=>{},getAttribute:()=>null,removeAttribute:()=>{},hasAttribute:()=>!1,classList:{add:()=>{},remove:()=>{},toggle:()=>!1,contains:()=>!1},style:new Proxy({},{get:()=>"",set:()=>!0}),innerHTML:"",innerText:"",textContent:"",children:[],childNodes:[],parentNode:null,parentElement:null,firstChild:null,lastChild:null,previousSibling:null,nextSibling:null,nodeName:"DIV",nodeType:1,nodeValue:null,ownerDocument:null};return r};globalThis.document={querySelector:()=>null,querySelectorAll:()=>[],getElementById:()=>null,getElementsByTagName:()=>[],getElementsByClassName:()=>[],getElementsByName:()=>[],createElement:()=>e(),createTextNode:()=>e(),createDocumentFragment:()=>e(),createComment:()=>e(),createAttribute:()=>({name:"",value:""}),body:e(),head:e(),documentElement:e(),title:"",cookie:"",domain:"",URL:"",readyState:"complete",addEventListener:()=>{},removeEventListener:()=>{},dispatchEvent:()=>!0}}typeof window>"u"&&(globalThis.window=globalThis);const P=new Te("Background"),Xe=new Map,mt=[{test:/ebay\.com\.au/i,file:Ue,name:"ebay"},{test:/walmart\.com/i,file:$e,name:"walmart"},{test:/amazon\.(com|com\.au)/i,file:Ge,name:"amazon"}];async function gt(){P.info("Initializing background service worker...");try{await nt(),P.info("Services initialized"),it(),ot(),ut(),P.info("Message handlers registered"),chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(e=>P.error("Failed to set panel behavior",e)),chrome.runtime.onInstalled.addListener(e=>{e.reason==="install"?P.info("Extension installed"):e.reason==="update"&&P.info(`Extension updated to version ${chrome.runtime.getManifest().version}`),chrome.contextMenus.create({id:"ask-guidance-system",title:"Ask Guidance System",contexts:["selection","page"]},()=>{chrome.runtime.lastError?P.error("Failed to create context menu",chrome.runtime.lastError):P.info("Context menu created successfully")})}),P.info("Background service worker initialized successfully")}catch(e){P.error("Failed to initialize background service worker",e)}}chrome.contextMenus.onClicked.addListener(async(e,r)=>{var t;if(P.info("[ContextMenu] Context menu clicked, menuItemId:",e.menuItemId),e.menuItemId==="ask-guidance-system"){P.debug("[ContextMenu] ask-guidance-system clicked");let s=((t=e.selectionText)==null?void 0:t.trim())||"";if(P.debug("[ContextMenu] Selection text:",s?`"${s}"`:"(empty)"),!s&&(r!=null&&r.id)){P.debug("[ContextMenu] No selection, fetching page state for tab:",r.id);try{const{messaging:a}=oe(),c=await a.sendToTab(r.id,f.GET_PAGE_STATE,{});if(P.debug("[ContextMenu] Page state response:",c),c.success&&c.data){const i=c.data,F=i.title||"",w=i.url||"",X=i.visibleText?i.visibleText.substring(0,500):"";s=`Please analyze this page:

Title: ${F}
URL: ${w}

Content:
${X}`,P.debug("[ContextMenu] Generated page summary text")}}catch(a){P.error("[ContextMenu] Failed to get page state",a),s="Please analyze the current page and help me understand what I can do here."}}if(s||(s="Please analyze the current page and help me understand what I can do here.",P.debug("[ContextMenu] Using fallback text")),P.info("[ContextMenu] Final text to send:",s.substring(0,100)+"..."),r!=null&&r.windowId)try{P.debug("[ContextMenu] Opening side panel for window:",r.windowId),await chrome.sidePanel.open({windowId:r.windowId}),P.info("[ContextMenu] Side panel opened successfully"),setTimeout(()=>{P.debug("[ContextMenu] Attempting to send SEND_SELECTED_TEXT to sidepanel");const a={type:f.SEND_SELECTED_TEXT,payload:{text:s}};P.info("[ContextMenu] Sending message to sidepanel:",a),chrome.runtime.sendMessage(a).then(()=>{P.info("[ContextMenu] Message sent successfully to sidepanel")}).catch(c=>{P.debug("[ContextMenu] Send failed (expected if sidepanel not ready):",c.message)})},800)}catch(a){P.error("[ContextMenu] Failed to open side panel",a)}else P.error("[ContextMenu] No windowId available, cannot open side panel")}});self.addEventListener("activate",()=>{P.debug("Service worker activated")});chrome.tabs.onUpdated.addListener((e,r,t)=>{try{if(r.status!=="complete"||!(t!=null&&t.url))return;for(const s of mt)if(s.test.test(t.url)){const a=Xe.get(e)??new Set;if(a.has(s.name))return;P.debug(`Injecting site module ${s.name} into tab ${e}`),chrome.scripting.executeScript({target:{tabId:e},files:[s.file]},()=>{a.add(s.name),Xe.set(e,a),P.info(`Injected ${s.name} into tab ${e}`)});return}}catch(s){P.error("Site injection failed",s)}});let _e=null;async function ht(e){(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT]})).length>0||(_e?await _e:(_e=chrome.offscreen.createDocument({url:e,reasons:[chrome.offscreen.Reason.USER_MEDIA],justification:"Speech recognition requires microphone access for voice command input"}),await _e,_e=null))}async function yt(){const{messaging:e}=oe();e.registerHandler(f.START_RECORDING,async()=>{try{return await ht("src/offscreen/offscreen.html"),await new Promise(r=>setTimeout(r,100)),chrome.runtime.sendMessage({type:f.START_RECORDING}),P.info("START_RECORDING forwarded to offscreen document"),{success:!0}}catch(r){return P.error("Failed to start recording",r),{success:!1,error:r.message}}}),e.registerHandler(f.STOP_RECORDING,async()=>(chrome.runtime.sendMessage({type:f.STOP_RECORDING}).catch(()=>{}),P.info("STOP_RECORDING forwarded to offscreen document"),{success:!0})),chrome.runtime.onMessage.addListener((r,t,s)=>{var a;if(r.type==="OPEN_SIDEBAR")return P.info("OPEN_SIDEBAR request received"),(async()=>{try{const c=t.tab;c!=null&&c.windowId?(await chrome.sidePanel.open({windowId:c.windowId}),P.info("Sidebar opened successfully"),s({success:!0})):(P.error("No tab windowId available"),s({success:!1,error:"No tab windowId"}))}catch(c){P.error("Failed to open sidebar:",c),s({success:!1,error:c.message})}})(),!0;if(r.type==="TRANSCRIPT"||r.type===f.TRANSCRIPT)P.debug("TRANSCRIPT received from offscreen, broadcasting to sidepanel"),e.broadcast(f.TRANSCRIPT,r.payload||r).catch(c=>{});else if(r.type==="RECORDING_STARTED"||r.type===f.RECORDING_STARTED)P.debug("RECORDING_STARTED received, broadcasting"),e.broadcast(f.RECORDING_STARTED,{}).catch(c=>{});else if(r.type==="RECORDING_STOPPED"||r.type===f.RECORDING_STOPPED)P.debug("RECORDING_STOPPED received, broadcasting"),e.broadcast(f.RECORDING_STOPPED,{}).catch(c=>{});else if(r.type==="RECORDING_ERROR"||r.type===f.RECORDING_ERROR){const c=r.error||((a=r.payload)==null?void 0:a.error)||(typeof r.payload=="string"?r.payload:"Unknown error");P.error("RECORDING_ERROR received:",c),e.broadcast(f.RECORDING_ERROR,{error:c}).catch(i=>{})}}),e.registerHandler(f.TRANSCRIPT,async r=>({success:!0,data:r})),e.registerHandler(f.RECORDING_STARTED,async()=>({success:!0})),e.registerHandler(f.RECORDING_STOPPED,async()=>({success:!0})),e.registerHandler(f.RECORDING_ERROR,async r=>({success:!1,error:r.error})),P.info("Recording handlers registered")}gt().then(()=>{yt()});export{oe as getServices};
